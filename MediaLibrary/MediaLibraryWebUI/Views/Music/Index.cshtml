@using MediaLibraryWebUI.Models.Configurations
@using MediaLibraryWebUI.Repositories
@model MediaLibraryWebUI.Models.MusicViewModel

<div class="d-flex flex-column" style="flex: 1 1 auto">
    <div style="flex: 0 0 auto">
        <h2>Music</h2>
        <div class="nav d-block" id="@(HtmlControlsRepository.MusicTabListId)" role="tablist">
            <a class="btn btn-outline-secondary" id="@(HtmlControlsRepository.AlbumsContainerId)-tab" data-toggle="tab"
               role="tab" aria-controls="@(HtmlControlsRepository.AlbumsContainerId)" aria-selected="true" title="@(nameof(Enums.MusicTabs.Albums))" data-music-tab="@(nameof(Enums.MusicTabs.Albums))"
               data-tooltip="tooltip" href="#@(HtmlControlsRepository.AlbumsContainerId)">
                <i class="fa fa-compact-disc"></i>
            </a>
            <a class="btn btn-outline-secondary" id="@(HtmlControlsRepository.ArtistsContainerId)-tab" data-toggle="tab"
               role="tab" aria-controls="@(HtmlControlsRepository.ArtistsContainerId)" aria-selected="false" title="@(nameof(Enums.MusicTabs.Artists))" data-music-tab="@(nameof(Enums.MusicTabs.Artists))"
               data-tooltip="tooltip" href="#@(HtmlControlsRepository.ArtistsContainerId)">
                <i class="fa fa-user"></i>
            </a>
            <a class="btn btn-outline-secondary" id="@(HtmlControlsRepository.SongsContainerId)-tab" data-toggle="tab"
               role="tab" aria-controls="@(HtmlControlsRepository.SongsContainerId)" aria-selected="false" title="@(nameof(Enums.MusicTabs.Songs))" data-music-tab="@(nameof(Enums.MusicTabs.Songs))"
               data-tooltip="tooltip" href="#@(HtmlControlsRepository.SongsContainerId)">
                <i class="fa fa-music"></i>
            </a>
            <div class="float-right d-none d-lg-block">
                <button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#@(HtmlControlsRepository.NewSongModalId)" data-tooltip="tooltip" title="Add new song">
                    <i class="fa fa-plus"></i>
                </button>
                <button class="btn btn-outline-secondary" onclick="refreshClicked()" data-tooltip="tooltip" title="Check for new music"><i class="fa fa-sync"></i></button>
                @Html.DropDownListFor(x => x.Configuration.SelectedAlbumSort,
                                      Model.AlbumSortItems,
                                      null,
                                      new { @class = "custom-select border border-secondary" + (Model.Configuration.SelectedMusicTab == Enums.MusicTabs.Albums ? "" : " d-none"),
                                          style = "width: 135px",
                                          title = "Sort by",
                                          data_sort_tab = "albums-tab",
                                          onchange = $"sortChanged('{nameof(Model.Configuration.SelectedAlbumSort)}', this)",
                                          data_tooltip = "tooltip"
                                      })
                @Html.DropDownListFor(x => x.Configuration.SelectedArtistSort,
                                      Model.ArtistSortItems,
                                      null,
                                      new { @class = "custom-select border border-secondary" + (Model.Configuration.SelectedMusicTab == Enums.MusicTabs.Artists ? "" : " d-none"),
                                          style = "width: 135px",
                                          title = "Sort by",
                                          data_sort_tab = "artists-tab",
                                          onchange = $"sortChanged('{nameof(Model.Configuration.SelectedArtistSort)}', this)",
                                          data_tooltip = "tooltip"
                                      })
                @Html.DropDownListFor(x => x.Configuration.SelectedSongSort,
                                      Model.SongSortItems,
                                      null,
                                      new { @class = "custom-select border border-secondary" + (Model.Configuration.SelectedMusicTab == Enums.MusicTabs.Songs ? "" : " d-none"),
                                          style = "width: 135px",
                                          title = "Sort by",
                                          data_sort_tab = "songs-tab",
                                          onchange = $"sortChanged('{nameof(Model.Configuration.SelectedSongSort)}', this)",
                                          data_tooltip = "tooltip"
                                      })
            </div>
        </div>
        <hr />
    </div>
    <div class="tab-content" style="flex: 1 1 auto; overflow-y: auto">
        <div class="tab-pane fade" id="@(HtmlControlsRepository.AlbumsContainerId)" role="tabpanel" aria-labelledby="@(HtmlControlsRepository.AlbumsContainerId)-tab" data-load-url="@Url.Action("GetAlbums", "Music")"></div>
        <div class="tab-pane fade" id="@(HtmlControlsRepository.ArtistsContainerId)" role="tabpanel" aria-labelledby="@(HtmlControlsRepository.ArtistsContainerId)-tab" data-load-url="@Url.Action("GetArtists", "Music")"></div>
        <div class="tab-pane fade" id="@(HtmlControlsRepository.SongsContainerId)" role="tabpanel" aria-labelledby="@(HtmlControlsRepository.SongsContainerId)-tab" data-load-url="@Url.Action("GetSongs", "Music")"></div>
    </div>
</div>

@Html.Partial("~/Views/Shared/Modals/AddToPlaylistModal.cshtml", Model)
@Html.Partial("~/Views/Shared/Modals/AddNewSongModal.cshtml", Model)
@Html.Partial("~/Views/Shared/Modals/EditSongModal.cshtml")

<script type="text/javascript" defer="defer">
    function sortChanged(sortType, select) {
        showLoading();

        if (sortType === '@(nameof(MusicConfiguration.SelectedAlbumSort))') {
            set@(nameof(MusicConfiguration))_@(nameof(MusicConfiguration.SelectedAlbumSort))($(select).val());
        } else if (sortType === '@(nameof(MusicConfiguration.SelectedArtistSort))') {
            set@(nameof(MusicConfiguration))_@(nameof(MusicConfiguration.SelectedArtistSort))($(select).val());
        } else if (sortType === '@(nameof(MusicConfiguration.SelectedSongSort))') {
            set@(nameof(MusicConfiguration))_@(nameof(MusicConfiguration.SelectedSongSort))($(select).val());
        }
        update@(nameof(MusicConfiguration))(() => loadView('@(nameof(Enums.MediaPages.Music))'));
    }

    function refreshClicked() {
        var success = () => hideLoading();

        showLoading();
        $.post('@(Url.Action("Refresh", "Music"))', success);

    }

    $('#@(HtmlControlsRepository.MusicTabListId) *[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        var $newTab = $(e.target),
            $oldTab = $(e.relatedTarget),
            $newView = $($newTab.attr('href')),
            $oldView = $($oldTab.attr('href'))
            url = $newView.attr('data-load-url'),
            success = () => {
                hideLoading();
                $newView.find('[data-tooltip="tooltip"]').tooltip({ trigger: "hover" });
            };

        $('#@(HtmlControlsRepository.MusicTabListId) *[data-sort-tab]').each((index, _btn) => {
         if ($(_btn).attr('data-sort-tab') === $newTab.attr('id')) {
                $(_btn).removeClass('d-none');
            } else {
                $(_btn).addClass('d-none');
            }
        });

        showLoading();
        set@(nameof(MusicConfiguration))_@(nameof(MusicConfiguration.SelectedMusicTab))($newTab.attr('data-music-tab'));
        $newView.find('[data-tooltip="tooltip"]').tooltip('dispose');
        update@(nameof(MusicConfiguration))(() => $newView.load(url, success));
    });

    $('[data-music-tab="@(Model.Configuration.SelectedMusicTab)"]').tab('show');
</script>