@using MediaLibraryWebUI.Models.Configurations
@using MediaLibraryWebUI.Repositories
@model MediaLibraryWebUI.Models.PodcastViewModel

@{
    IEnumerable<int> years = Model.SelectedPodcast.PodcastItems.Select(item => item.PublishDate.Year).Distinct().OrderByDescending(year => year);
}

<div class="d-flex flex-column" style="flex: 1 1 auto; overflow-y: auto">
    <div style="flex: 0 0 auto">
        <div class="d-flex flex-row">
            <div style="flex: 0 1 auto; overflow-x: auto">
                <h2 style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap">
                    @(Model.SelectedPodcast.Title) @(!Model.SelectedPodcast.Title.ToLower().Contains("podcast") ? "podcast" : string.Empty)
                </h2>
            </div>
        </div>
        <div>
            <button class="btn btn-outline-secondary" onclick="backClicked()" data-tooltip="tooltip" title="Go back"><i class="fa fa-arrow-circle-left"></i></button>
            <button class="btn btn-outline-secondary" onclick="refreshClicked()" data-tooltip="tooltip" title="Refresh podcast"><i class="fa fa-sync"></i></button>
            <button class="btn btn-outline-danger" data-delete-action="@(Url.Action("RemovePodcast","Podcast", new { Model.SelectedPodcast.Id }))"
                    data-tooltip="tooltip" title="Delete podcast" data-refresh-view="@(nameof(Enums.MediaPages.Podcast))" data-delete-type="podcast"
                    data-target="#@(HtmlControlsRepository.DeleteModalId)" data-toggle="modal">
                <i class="fa fa-trash"></i>
            </button>
            @Html.DropDownListFor(x => x.Configuration.SelectedPodcastFilter,
                         Model.PodcastFilterItems,
                         null,
                         new { @class = "custom-select border border-secondary float-right",
                               style = "width: 150px",
                               title = "Filter by",
                               onchange = "filterChanged(this)",
                               data_tooltip = "tooltip"
            })
        </div>
        <hr />
    </div>
    <div class="card" style="flex: 1 1 auto; overflow-y: auto">
        <div class="card-header" id="heading-podcast-@(Model.SelectedPodcast.Id)">
            <ul class="pagination justify-content-center m-0">
                <li class="page-item"><a class="page-link" href="javascript: void(0);" data-podcast-year="-">&laquo;</a></li>
                @foreach (var year in years)
                {
                    <li class="page-item"><a class="page-link" href="javascript: void(0);" data-podcast-year="@(year)">@(year)</a></li>
                }
                <li class="page-item"><a class="page-link" href="javascript: void(0);" data-podcast-year="+">&raquo;</a></li>
            </ul>
        </div>
        <div class="card-body m-0 p-0" id="@(HtmlControlsRepository.PodcastViewId)" style="flex: 1 1 auto; overflow-y: auto"></div>
    </div>
</div>

@Html.Partial("~/Views/Shared/Modals/DeleteModal.cshtml")

<script type="text/javascript" defer="defer">
    function backClicked() {
        showLoading();
        set@(nameof(PodcastConfiguration))_@(nameof(PodcastConfiguration.SelectedPodcastPage))('@(nameof(Enums.PodcastPages.Index))');
        update@(nameof(PodcastConfiguration))(() => loadView('@(nameof(Enums.MediaPages.Podcast))'));
    }

    function refreshClicked() {
        var success = () => loadView('@(nameof(Enums.MediaPages.Podcast))');

        showLoading();
        $.post('@(Url.Action("RefreshPodcast","Podcast"))', { id: @(Model.SelectedPodcast.Id) }, success);

    }

    function downloadClicked(btn) {
        var $btn = $(btn);

        $btn.tooltip('dispose');
        $btn.prop('disabled', 'disabled');
        $.get($btn.attr('data-download-action'));
    }

    $('[data-podcast-year]').on('click', function () {
        var year = $(this).attr('data-podcast-year'),
            years = '@(string.Join(",", years))'.split(','),
            currentIndex = years.indexOf(getSelectedYear());

        if (year === '-' && currentIndex > 0) {
            $('[data-podcast-year="' + years[currentIndex - 1] + '"]').trigger('click');
        } else if (year === '+' && (currentIndex + 1) < years.length) {
            $('[data-podcast-year="' + years[currentIndex + 1] + '"]').trigger('click');
        } else if (parseInt(year) > 0) {
            $('li.page-item').removeClass('active');
            loadPodcastView(this);
        }
    });

    function loadPodcastView(item) {
        var success = () => {
                $(item).parent('li.page-item:first').addClass('active');
                loadTooltips($('#@(HtmlControlsRepository.PodcastViewId)')[0]);
                hideLoading();
            },
            id = @(Model.SelectedPodcast.Id),
            year = $(item).attr('data-podcast-year'),
            filter = get@(nameof(PodcastConfiguration))_@(nameof(PodcastConfiguration.SelectedPodcastFilter))();

        if (item) {
            showLoading();
            disposeTooltips($('#@(HtmlControlsRepository.PodcastViewId)')[0]);
            $('#@(HtmlControlsRepository.PodcastViewId)').load('@Url.Action("GetPodcastItems", "Podcast")', { id: id, year: year, filter: filter }, success);
        }
    }

    function getSelectedYear() {
        return $('li.page-item.active a.page-link[data-podcast-year]').attr('data-podcast-year');
    }

    function handle@(Enums.MediaPages.Podcast)Loaded() {
    }

    function filterChanged(select) {
        showLoading();
        set@(nameof(PodcastConfiguration))_@(nameof(PodcastConfiguration.SelectedPodcastFilter))($(select).val());
        update@(nameof(PodcastConfiguration))(() => loadView('@(nameof(Enums.MediaPages.Podcast))'));
    }

    $('[data-podcast-year="@(years.FirstOrDefault())"]').trigger('click');
</script>
